name: Update Tech RSS Feed

on:
  schedule:
    # Every 20 minutes
    - cron: '*/20 * * * *'
  workflow_dispatch:

jobs:
  build-rss:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2. Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3. Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml

      # 4. Generate RSS feed
      - name: Generate RSS feed
        run: |
          python << 'EOF'
          import requests
          from bs4 import BeautifulSoup
          from datetime import datetime
          import xml.etree.ElementTree as ET

          URL = "https://www.reuters.com/technology/"

          headers = {
              "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
          }

          try:
              response = requests.get(URL, headers=headers)
              response.raise_for_status()
              soup = BeautifulSoup(response.text, "lxml")

              # Create the RSS feed root
              rss = ET.Element("rss", version="2.0")
              channel = ET.SubElement(rss, "channel")
              ET.SubElement(channel, "title").text = "Reuters Technology RSS"
              ET.SubElement(channel, "link").text = "https://rebus77.github.io/r_tech/"
              ET.SubElement(channel, "description").text = "RSS feed for Reuters Technology news"

              # Find articles
              articles = soup.select("article")[:15]  # top 15 articles
              for art in articles:
                  title_tag = art.find("h3")
                  link_tag = art.find("a")
                  desc_tag = art.find("p")

                  if title_tag and link_tag:
                      item = ET.SubElement(channel, "item")
                      ET.SubElement(item, "title").text = title_tag.get_text(strip=True)
                      link = link_tag.get("href")
                      if link.startswith("/"):
                          link = "https://www.reuters.com" + link
                      ET.SubElement(item, "link").text = link
                      ET.SubElement(item, "guid").text = link
                      ET.SubElement(item, "description").text = desc_tag.get_text(strip=True) if desc_tag else ""
                      ET.SubElement(item, "pubDate").text = datetime.utcnow().strftime("%a, %d %b %Y %H:%M:%S +0000")

              tree = ET.ElementTree(rss)
              tree.write("feed.xml", encoding="utf-8", xml_declaration=True)
              print("RSS feed generated successfully.")

          except Exception as e:
              print(f"Error generating RSS feed: {e}")
  EOF

      # 5. Commit and push RSS feed
      - name: Commit and push RSS feed
        uses: ad-m/github-push-action@v0.8.0
        with:
          branch: main
          github_token: ${{ secrets.GITHUB_TOKEN }}
          directory: .
          force: true
