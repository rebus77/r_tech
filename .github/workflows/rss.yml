name: Update Tech RSS Feed

on:
  schedule:
    - cron: '0 * * * *'  # every hour
  workflow_dispatch:

jobs:
  update-rss:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 feedgen

      - name: Fetch tech news and build RSS
        run: |
          python << 'EOF'
          import requests
          from bs4 import BeautifulSoup
          from feedgen.feed import FeedGenerator
          import datetime
          import os

          RSS_FILE = "rss.xml"

          try:
              # Fetch Google News technology section
              url = "https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRWdvSUwyMHZNRGx1YlY4U0FtVnVLQUFQAQ?hl=en-US&gl=US&ceid=US:en"
              r = requests.get(url, timeout=10)
              r.raise_for_status()

              soup = BeautifulSoup(r.content, "xml")
              items = soup.find_all("item")[:15]

              fg = FeedGenerator()
              fg.title("Tech News")
              fg.link(href="https://news.google.com", rel="alternate")
              fg.description("Latest technology news")
              fg.language("en")

              for item in items:
                  fe = fg.add_entry()
                  fe.title(item.title.text)
                  fe.link(href=item.link.text)
                  fe.description(item.description.text)
                  fe.pubDate(item.pubDate.text)

              fg.rss_file(RSS_FILE)
              print(f"RSS feed written to {RSS_FILE}")

          except Exception as e:
              print("Error fetching or generating RSS feed:", e)
              if os.path.exists(RSS_FILE):
                  print(f"Keeping existing feed {RSS_FILE}")
              else:
                  raise e
          EOF

      - name: Commit and push RSS feed
        uses: ad-m/github-push-action@v0.15.0
        with:
          branch: main
          force: true
          github_token: ${{ secrets.GITHUB_TOKEN }}
