name: Generate Reuters Technology RSS

on:
  workflow_dispatch: {}
  schedule:
    - cron: '*/20 * * * *'  # every 20 minutes

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 feedgen python-dateutil

      - name: Generate RSS feed
        run: |
          python << 'EOF'
          import requests, datetime
          from bs4 import BeautifulSoup
          from feedgen.feed import FeedGenerator
          from dateutil.parser import parse

          fg = FeedGenerator()
          fg.title('Reuters Technology RSS')
          fg.link(href='https://rebus77.github.io/r_tech/')
          fg.description('RSS feed for Reuters Technology news')

          url = 'https://www.reuters.com/technology/'
          r = requests.get(url)
          soup = BeautifulSoup(r.text, 'html.parser')

          # Updated scraper for Reuters
          articles = soup.find_all("div", attrs={"data-testid": "story"})
          for item in articles[:15]:
              a_tag = item.find("a")
              if not a_tag:
                  continue
              link = "https://www.reuters.com" + a_tag.get("href", "")
              title = a_tag.get_text(strip=True)
              time_tag = item.find("time")
              pub_dt = parse(time_tag["datetime"]) if time_tag else datetime.datetime.utcnow()

              fe = fg.add_entry()
              fe.id(link)
              fe.link(href=link)
              fe.title(title)
              fe.pubDate(pub_dt)

          fg.rss_file('feed.xml')
          EOF

      - name: Commit and push RSS feed
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "actions@github.com"
          git add feed.xml
          git commit -m "Update RSS feed"
          git push https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main || echo "No changes to commit"
